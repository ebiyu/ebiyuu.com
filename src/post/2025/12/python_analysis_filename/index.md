---
layout: blog
title: title
date: 2025-12-05
draft: true
tags:
  -
---

Pythonでデータ分析やグラフ作成をしてると、「この図ってどのスクリプト・どの条件で作ったんだっけ？」が多発する。これを解決するために、

- 1成果物1ファイルでスクリプトを作り、
- `__file__` を使うことでスクリプトファイルと成果物を対応させる

運用を紹介する。1年間ほど行ってきて固まってきたものを紹介する。

## これまでの課題

- **スクリプトを書き換えてしまい、どの条件で出した図かわからなくなる**
	- Jupyter Notebookなどを用いている場合も書き換えがちなので同様
- 入力ファイルなどを引数にして管理しても、
	- 最初はパラメータだと思っていなかったところを後から変えたくなったり
	- パラメータが増えていくと実行するのが大変になるなど、
	- どうしても本体のスクリプトを書き換えたくなる
- 修正版を作るためにスクリプトをコピーすると増えていき、**どの成果物がどのスクリプトから出力したものなのか分からなくなってしまう**。

つまり、成果物とスクリプトの紐付けが失われやすいのが課題

## 解決するための運用

### 1成果物1スクリプトの運用にする

例えば、`251205_data1_plot.py` というスクリプトは `251205_data1_plot.png` を生成する

- 同じスクリプトで別のデータを出力する際も別のファイルにする
	- これは、後からグラフの文言や縦軸・横軸を変えたくなったりすることがあるため。

### スクリプトは基本的に書き換えずコピーする（イミュータブル運用）

基本スクリプトの書き換えはせず、コピーして新規スクリプトを作る（イミュータブルルール）

- 明らかに間違えたとかであればOK。
- 一方で昔に作ったグラフであればコピーして修正するのがベター。

実際はスクリプトを作成した日付を頭につける運用をしている。
ファイル名が増えてくると命名が困難になるという問題があるが、日付をつけておけば同じ日付内での重複だけ避ければよい。

### 共通化はあえてしない

特にプログラミングに慣れている人は前処理や描画の共通化をしたくなるが…

- ただ、もし前処理だけ変えたくなったら？
- 一部だけ変えたくなったときにライブラリ側を変更すると、他のスクリプトの再現性を壊す
- 1ファイルに全部書いておいて、まるごとコピペするのがベスト

そこで、1ファイル完結で書き、必要ならそのままコピペが一番トラブルが少ない。

### `__file__` で自動的に出力ファイル名を決める

- `__file__` を使うことでファイル名を取得できるので、これを用いて出力ファイル名を決定するとファイルと成果物（グラフ画像など）が一対一対応できる
	- また、スクリプトを別名保存した際にはグラフも新しい名前で自動的に作成される。
- `pathlib` の `with_suffix()` を用いるとこれが簡略に書ける

例: 

```python
from pathlib import Path

import matplotlib.pyplot as plt

fig, ax = plt.subplots(figsize=(10, 8), constrained_layout=True) # example

# plot here

plt.savefig(Path(__file__).with_suffix('.png'))
plt.show()
```

### 最後に、これらを全部1つのリポジトリに入れる

以下のようなフォルダ構造にしている。

```
data/
	yymmdd_<slug>/       # 実験日と実験内容で分類
		**/*.csv         # 実験データファイル
scripts/
    yymm/                    # 年月で分類
        yymmdd_<slug>.py     # 解析スクリプト（1成果物1スクリプト）
pyproject.toml
uv.lock
CLAUDE.md
```

- 今のところは、全ての生データと解析スクリプトを入れている。
	- プロジェクトごとにフォルダを作ってもよいが、「これどこに入れよう？」が毎回無駄になっている。
	- 結局日付での管理が最強で思い出しやすい。（参考: スマホのカメラロール）
		- 実験ノートに日付付きでメモしているので辿れる
- Claude codeなどを用いることで、他のスクリプトのデータだけ差し替えたものを作ったりできる。
	- プロンプト例: 「scripts/yymm/yymmdd_analysis1.py を参考にして、 data/yymmdd_exp1/exp1.csv を可視化するスクリプトを作成してください。」
- できればgitで管理する
	- バックアップのため。慣れていなければ定期的に全体をzipしてクラウドにバックアップしておくような運用でも、まあ、よい。
		- イミュータブルルールにより、バージョン管理の重要性が少ない。
	- `data` フォルダはgit管理してもしなくてもよい
		- データが軽量なのであればgit管理しておくとバックアップにもなるし同期が楽
		- 重いのであればLFSや別のクラウドストレージで管理するなどの方法を取ってもよい
	- コミットメッセージは適当
		- コミットメッセージで（内容に関係なくてよいので）日記をつけている。以外と記憶が連想で思い出しやすくてよい。
		- もちろんちゃんとメッセージを書いてもよい。

## AIとの適正もgood

スクリプトが1ファイルで完結していることにより、AIによるコードレビューや修正も用意。

- 「このファイルを直して」とそのまま渡せる
- 文脈が1ファイル内で閉じているため誤解が少ない
- claude codeなどのコーディングエージェントをわざわざ用いずとも、Web上のChatGPTやGeminiなどの画面にコピペすれば済む。

AI支援時代のスクリプト管理としても合理的。

ちなみに私はclaude codeを使っている。[CLAUDE.md](./CLAUDE.md.txt)を設定している。


## 差分が確認しづらい問題

「共通化をしない」「gitなどのバージョン管理ツールを使わずにコピペで履歴管理する」ことによって、どの部分を変更したのか忘れてしまったりする。

積極的にdiffをとろう。vscodeであれば右クリックでcompareできるし、コマンドラインだったらdiffコマンドが使える。winmergeなどを使ってもよいだろう。

## ファイルの実行が面倒な問題

毎回 `python` コマンドを実行するのが（jupyter notebookなどと比較して）面倒である問題
これに対しては、スクリプトファイルをwatchして保存時に自動的に実行するスクリプトを用意している。
